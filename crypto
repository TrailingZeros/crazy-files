#!/usr/bin/env groovy
import com.google.common.io.Files as GFiles
@GrabResolver(name = 'jitpack', root = 'https://jitpack.io')
@GrabResolver(name = 'central', root = 'http://central.maven.org/maven2/')
@Grab('com.github.nao20010128nao:Cryptorage:e2aea01')
import com.nao20010128nao.Cryptorage.ExposedKt as UtilsKt
import groovy.json.*
import java.nio.file.Files as JFiles

final maxScore=1024*1024*1024

//def home=new File(System.env["HOME"])
//def videos=new File(home,"videos")
def videos=new File('.')
def anyway=new File('./anyway')

def transferTo=new File(videos,args.length>=1?args[0]:"bkup")
transferTo.mkdirs()

def crypto=UtilsKt.withV1Encryption(UtilsKt.asFileSource(transferTo), System.env.PASSWORD)
crypto.meta("split_size", "${5000000}")

def toPut = new JsonSlurper().parseText("./listfiles".execute().in.text).collect{new File(it)}.sort{a,b->
  return b.length()<=>a.length()
}

def ended = new File(videos,'ok')
ended.mkdirs()

if(!toPut){
    System.exit(2)
    return
}

def totalPutSize=toPut.inject(0){r,a->r+a.length()}
println "totalPutSize: $totalPutSize"
def currentScore=maxScore-(crypto.list().inject(0){r,a->r+crypto.size(a)})
println "currentScore: ${currentScore}"

def finalFiles=[]

toPut.each{a->
    final entryScore=a.length()
    if(currentScore>=entryScore){
        // pass
        currentScore-=entryScore
        finalFiles+=a
    }
}
println "remainingScore: ${currentScore}"
def remaining=100-(int)((double)currentScore*100.0/(double)maxScore)
println "remaining percent: ${remaining}%"

println(finalFiles)

if(!finalFiles){
    System.exit(1)
    return
}

finalFiles.each{
    println "Copying $it as $it.name"
    def copied=false
    if(!crypto.has(it.name)||true){
        copied=true
        GFiles.asByteSource(it).copyTo crypto.put(it.name)
    }
}

println 'Running GC...'
crypto.doCompress()
crypto.gc()

println 'Committing'
crypto.commit()

finalFiles.each{
    def dest = new File(ended, it.name)
    dest.delete()
    JFiles.move it.toPath(), dest.toPath()
}

crypto.close()
