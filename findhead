#!/usr/bin/env groovy
@GrabResolver(name = 'jitpack', root = 'https://jitpack.io')
@GrabResolver(name = 'central', root = 'http://central.maven.org/maven2/')
@Grab('com.github.nao20010128nao:CryptorageExtras:2e85efd')
@Grab('com.github.nao20010128nao:HttpServerJava:4582a9d30f')
import com.nao20010128nao.Cryptorage.ExposedKt as UtilsKt
import com.nao20010128nao.CryptorageExtras.UtilsKt as Extras
import com.nao20010128nao.CryptorageExtras.indexer.IndexedKt

def pass = System.env.PASSWORD
def data=System.env.VIDEOS_PREFIX?:"data"
def master=System.env.VIDEOS_PREFIX?:"master"
def endpoint=System.env.ENDPOINT

def testNum={num->
  num++
  println "Testing $num"
  try{
    def fs = UtilsKt.asFileSource(
      new URL("$endpoint/$data-$num/raw/master")
    )
    return UtilsKt.withV1Encryption(fs, pass)
  }catch(e){
    return false
  }
}

int num=0
println "Testing every 100 numbers"
for(;;num+=100){
  if(!testNum(num)){
    break
  }
}

println "Doing 2-way shake"
def lower=num-100
def higher=num
while(lower!=higher){
  println "$lower $higher"
  num=(lower+higher)/2
  if(lower==num||higher==num){
    break
  }
  if(testNum(num)){
    lower=num+1
  }else{
    higher=num-1
  }
}


println "Result: $higher"
